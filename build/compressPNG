#!/usr/bin/env bash

# png.sh: compress a PNG with pngnq & optipng if the savings are worthwhile.
# Author: Gwern Branwen
# Date: 2013-01-01
# When:  Time-stamp: "2026-02-05 22:48:23 gwern"
# License: CC-0

set -euo pipefail

## apt-get install pngnq optipng parallel
command -v pngnq > /dev/null
command -v optipng > /dev/null
command -v parallel > /dev/null

## Inlining for portability
# shellcheck source=./bash.sh
# . ~/wiki/static/build/bash.sh # for 'get_image_files', 'green', 'red'
red  () { echo -e "\e[41m$@\e[0m"; }
green () { echo -e "\e[32m$@\e[0m"; }
get_image_files () {
    mapfile -t "$1" < <(find . -maxdepth 1 -type f \
                             \( -iname "*.png" \) \
                            | sort --version-sort)
}

N="14"

# do a mix of lossless then lossy optimization:
pngOne () {
    if [[ "$1" =~ .*\.png ]]; then
        local orig_size new_size
        orig_size=$(stat --printf="%s" "$1") # in bytes
        temp_file=$(mktemp --suffix=.png)
        cp "$1" "$temp_file"
         # WARNING: can't overwrite on Ubuntu as pngnq is buggy and will simply delete the file! so create lossy version and overwrite manually:
        nice --adjustment=19 pngnq -v -s1 "$temp_file"
        optimized_file="${temp_file%.*}"-nq8.png
        if [ -f "$optimized_file" ]; then
            nice --adjustment=19 optipng -o9 "$optimized_file"
            new_size=$(stat --printf="%s" "$optimized_file")
            # calculate the percentage difference
            diff=$(echo "scale=2; 100*(($orig_size - $new_size)/$orig_size)" | bc)
            # only replace if new file is at least 10% smaller
            if (( $(echo "$diff >= 10" | bc --mathlib) )); then
                mv "$optimized_file" "$1";
            else
                green "Optimized file of $1 is not at least 10% smaller ($orig_size â†’ $new_size ; reduction: $diff%). Leaving the original file untouched."
            fi
        else
            green "Optimized file $optimized_file doesn't exist. Leaving the original file untouched."
        fi

        rm --force -- "$temp_file" "$optimized_file"
    else
        green "File $1 is not a PNG. Skipping."
    fi
}
export -f pngOne

args=("$@")
if [ ${#args[@]} -eq 0 ]; then
    get_image_files args
    green "Attempting to use implied arguments: ${args[@]}"
fi

if [ ${#args[@]} -eq 0 ]; then
    red "Error: no arguments available!"; exit 1
else

    for ITEM in "${args[@]}"; do
        if [ -f "$ITEM" ]; then
            pngOne "$ITEM" &
        elif [ -d "$ITEM" ]; then
            find "$ITEM" -type f -name "*.png" | sort | parallel --jobs "$N" -- pngOne
        fi
    done
fi
